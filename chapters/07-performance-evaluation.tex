\chapter{Method Evaluation}
\label{chap:performance-evaluation}
This chapter presents the evaluation of the machine learning-based jet assignment methods described in \Cref{chap:ml-jet-selection} and compares their performance to the conventional baseline methods outlined in \Cref{sec:jet_assignment}.
\section{Accuracy Metrics}
\begin{table}[H]
    \centering
    \input{plots/Transformer_HLF/reconstruction_accuracies_table}
    \caption{Reconstruction accuracies for the different jet assignment methods on the test dataset.}
    \label{tab:reconstruction_accuracies}
\end{table}
Since the jet assignment task is the core focus of this thesis, the primary evaluation metric is the assignment accuracy, as introduced in \Cref{sec:performance-metrics}. \Cref{tab:reconstruction_accuracies} summarizes the assignment accuracies achieved by the different methods on the test dataset. 
The results show, that the transformer-based jet assignment model only slightly outperforms the conventional methods, in terms of selection accuracy. This is generally not surprising, all methods strongly rely on the $b$-tagging performance to select the two $b$-jet candidates. While it is possible for the transformer to learn patterns in the kinematic features of the jets to improve the selection, the $b$-tagging information is still the dominant factor. The transformer achieves a selection accuracy of $95.82\%$, compared to $92.33\%$ for both conventional methods, resulting in an improvement of about $3.8\%$.

However, when looking at the assignment accuracy, which requires not only selecting the correct jets but also assigning them to the correct parton-level $b$-quarks, the transformer provides a significant improvement over the conventional methods. The transformer achieves an assignment accuracy of $81.79\%$, compared to $73.83\%$ for the $\chi^2$-Method and $63.43\%$ for the $\Delta R$-Method. The corresponds to improvements of about $10.7\%$ and $28.9\%$, respectively.

Generally, this indicates, that while the conventional methods can effectively select the correct $b$-jets, they struggle with correctly assigning them to the parent partons. The transformer, on the other hand, is able to learn more complex patterns in the event kinematics, leading to a substantial improvement in assignment accuracy.
\subsection{Variable Dependent Performance}
To gain further insights into the performance of the jet assignment methods, the accuracy is evaluated as a function of key physics variables.
\begin{figure}[h]
    \begin{subfigure}{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/Transformer_HLF/binned_selection_accuracy_N_jets.pdf}
        \caption{Selection Accuracy}
        \label{fig:selection_accuracy_n_jets}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/Transformer_HLF/binned_accuracy_N_jets.pdf}
        \caption{Assignment Accuracy}
        \label{fig:assignment_accuracy_n_jets}
    \end{subfigure}
    \caption{Accuracy metrics as a function of the number of jets in the event for the different jet assignment methods. The error bars represent the statistical uncertainty. The distribution of events across the bins is shown in the red distribution in the background. A dotted line, indicates the expected accuracy from random guessing based on the number of jet combinations in each bin.}
    \label{fig:accuracy_n_jets}
\end{figure}

As the combinatorial complexity of the jet assignment task increases with the number of jets in the event, it is expected that the accuracy decreases for events with more jets. Due to the nature of hadron colliders, however, background jets are abundant at the \lhc.  \Cref{fig:accuracy_n_jets} depicts the selection and assignment accuracies as a function of the number of jets in the event.
Both accuracies decrease for events with a higher jet multiplicity using all examined methods. However, the transformer consistently outperforms the conventional methods across all jet multiplicities. Notably, the performance gap widens for events with more jets, highlighting the transformer's ability to handle increased combinatorial complexity more effectively.

While the overall selection accuracy showed no major improvement for the transformer over the conventional methods, it is evident from \Cref{fig:selection_accuracy_n_jets}, that the transformer achieves a notably higher selection accuracy in events with a larger number of jets. This suggests that the transformer is better at discerning the correct $b$-jets in more complex event topologies, likely due to its ability to learn intricate patterns in the kinematic features of the jets.
This allows analyses to utilise events with higher jet multiplicities more effectively, potentially increasing the statistical power of measurements and searches.

\begin{figure}
    \begin{subfigure}{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/Transformer_HLF/binned_accuracy_ttbar_mass.pdf}
        \caption{Assignment Accuracy}
        \label{fig:assignment_accuracy_m_ttbar}
    \end{subfigure}
    \begin{subfigure}{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/Transformer_HLF/binned_accuracy_quotient_ttbar_mass.pdf}
        \caption{Accuracy Quotient}
        \label{fig:accuracy_quotient_m_ttbar}
    \end{subfigure}
    \caption{Accuracy metrics as a function of the reconstructed $t\bar{t}$ invariant mass for the different jet assignment methods. The error bars represent the statistical uncertainty. The distribution of events across the bins is shown in the red distribution in the background. A dotted line, indicates the expected accuracy from random guessing based on the number of jet combinations in each bin.}
    \label{fig:accuracy_m_ttbar}
\end{figure}

\bigskip

As mentioned before, a lot of the interesting physics in dileptonic $t\bar{t}$ events happens close to the production threshold of the top-quark pair. Therefore, it is crucial for jet assignment methods to perform well in this region. \Cref{fig:accuracy_m_ttbar} shows the selection and assignment accuracies as a function of the true $t\bar{t}$ invariant mass (after final state radiation (FSR)). 

Both metrics and all methods yield a decreasing accuracy for lower $m(t\bar{t})$ values. This behaviour can be understood by considering the event kinematics at different invariant mass scales. Close to the production threshold, the top quarks are produced nearly at rest, leading to more isotropic decay products. This results in a higher likelihood of overlapping jets and leptons, complicating the jet assignment task. In contrast, at higher invariant masses, the top quarks are more boosted, causing their decay products to be more collimated and easier to distinguish. This can be seen in a lower $\eta$-$\phi$-separation of the leptons or smaller difference between correct and incorrect lepton jet pairing. The plots, outlining this trend, can be found in the Appendix in \Cref{fig:relational_jet_lepton_deltaR,fig:relational_jet_lepton_invariant_mass,fig:ttbar_mass_vs_deltaR_lep_nonmatch,fig:ttbar_mass_vs_dR_l1l2}. This affects the $\Delta R$-method the most, as it only relies on spatial separation for the assignment. While the drop of the transformer is less pronounced, it still suffers from a significant decrease to about $60\%$ compared to way above $90\%$ at higher invariant masses. Given the investigating in \Cref{sec:feature_evaluation}, the transformer is also highly reliant on these variables. Explaining, why it exhibits a similar drop in performance. In the lowest bin, the transformer and $\chi^2$-Method seem to be on par. When looking at the accuracy quotient in \Cref{fig:accuracy_quotient_m_ttbar}, however, it becomes evident, that the transformer solely outperforms the $\chi^2$-Method due to is increased jet-selection. When factoring out the selection performance, the $\chi^2$-Method can actually outperform the transformer in this regime. 

This highlights, that especially close to the production threshold, the neutrino kinematic reconstruction used in the $\chi^2$-Method provides valuable information for the jet assignment task, which the transformer is currently not able to fully exploit. This points towards a promising avenue for future improvements, by combining the transformer with neutrino reconstruction methods to provide a more holistic event interpretation. Interestingly, when looking at the accuracy quotient, the $\Delta R$-Method performs worse than random guessing in the lowest bin. This indicates, that at very low $m(t\bar{t})$ values, the spatial separation between jets and leptons becomes so ambiguous, that the $\Delta R$-Method is systematically misassigning jets. While the other methods still perform above random guessing, this highlights the challenges posed by events near the production threshold.

\begin{figure}
    \begin{subfigure}{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/Transformer_HLF/binned_accuracy_ttbar_pT.pdf}
        \caption{Assignment Accuracy}
        \label{fig:assignment_accuracy_pt_ttbar}
    \end{subfigure}
    \begin{subfigure}{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/Transformer_HLF/binned_accuracy_quotient_ttbar_pt.pdf}
        \caption{Accuracy Quotient}
        \label{fig:accuracy_quotient_pt_ttbar}
    \end{subfigure}
    \caption{Accuracy metrics as a function of the reconstructed $t\bar{t}$ invariant mass for the different jet assignment methods. The error bars represent the statistical uncertainty. The distribution of events across the bins is shown in the red distribution in the background. A dotted line, indicates the expected accuracy from random guessing based on the number of jet combinations in each bin.}
    \label{fig:accuracy_pt_ttbar}
\end{figure}

\bigskip

Another important variable to consider is the transverse momentum of the $t\bar{t}$ system, $p_T(t\bar{t})$. This variable is sensitive to additional QCD radiation and can impact the event topology. It was also used in previous \atlas analyses \cite{entanglement_top_quarks} to categorise events. \Cref{fig:accuracy_pt_ttbar} shows the assignment accuracy and accuracy quotient as a function of the true $p_T(t\bar{t})$ (after FSR).
The baseline methods exhibit a decreasing accuracy for higher $p_T(t\bar{t})$ values, which can be attributed to the increased jet activity and more complex event topologies associated with higher transverse momenta. This directly relates to the aforementioned challenges with higher jet multiplicities, as additional jets from initial and final state radiation reduces the selection accuracy, which in turn impacts the assignment accuracy. The transformer, however, maintains a relatively stable assignment accuracy across the entire $p_T(t\bar{t})$ spectrum.

When looking at the accuracy quotient in \Cref{fig:accuracy_quotient_pt_ttbar}, all methods show an increase for higher $p_T(t\bar{t})$ values. This indicates, that while the overall assignment accuracy decreases for the baseline methods, they are still able to effectively assign the jets once the correct ones have been selected. The transformer is able to compensate for the drop in selection accuracy at higher $p_T(t\bar{t})$ values, maintaining a consistent assignment performance.

\section{Impact on Physics Observables}
To investigate the possible impact of the improved jet assignment on physics analyses, the reconstruction of key observables is studied. For this purpose, the resolution of several reconstructed variables is compared between the different jet assignment methods. The (relative) resolution is defined as the standard (relative) deviation of the reconstructed and true value of the observable, normalized to the true value. Where the true value is taken from the parton-level information after final state radiation (FSR).
Since the main focus of this thesis is on the jet assignment task, the neutrino momenta are reconstructed using the same $\nu^2$-Flows method for all jet assignment methods to ensure a fair comparison.

\bigskip
\begin{figure}
    \centering
    \includegraphics[width=0.7\textwidth]{plots/Transformer_HLF/ttbar_mass_resolution_comparison.pdf}
    \caption{Relative resolution of the reconstructed $t\bar{t}$ invariant mass for the different jet assignment methods. The error bars represent the statistical uncertainty.}
    \label{fig:ttbar_mass_resolution_comparison}
\end{figure}

\Cref{fig:ttbar_mass_resolution_comparison} shows the relative resolution of the reconstructed $t\bar{t}$ invariant mass for the different jet assignment methods. Notably, this variable is only sensitive to the jet selection, as the invariant mass calculation is symmetric with respect to the two $b$-jets. 
Albeit the transformer only gains a slight improvement in selection accuracy over the conventional methods, this translates to a significant enhancement in the mass resolution (The binned plot of the selection accuracy can be found in the Appendix in \Cref{fig:binned_selecttion_accuracy_ttbar_mass}). This difference is most strongly pronounced for events with a low $t\bar{t}$ invariant mass. 
Also, it can be seen, that the resolution achieved by the transformer almost matches the ideal case of perfect jet selection, which is interesting given that the transformer still makes incorrect selection in about $4\%$ of the events. But, this is very close difference in selection accuracy between the transformer and the conventional methods, which results in a large difference in mass resolution.
This can be, due to the way the incorrect selections are distributed. If the conventional methods tend to select jets that are kinematically very different from the true $b$-jets when they make a mistake, this would lead to a larger degradation in mass resolution compared to the transformer. This highlights the importance of not only the selection accuracy but also the nature of the mistakes made by the jet assignment methods.

\bigskip
\begin{figure}
    \centering
    \includegraphics[width=0.7\textwidth]{plots/Transformer_HLF/c_hel_resolution_comparison.pdf}
    \caption{Resolution of the reconstructed top-quark spin correlation observable $c_{\text{hel}}$ for the different jet assignment methods. The error bars represent the statistical uncertainty. Additional to the different methods, the resolution for the case of perfect jet assignment is shown for reference.}
    \label{fig:top_pt_resolution_comparison}
\end{figure}
In \Cref{fig:top_pt_resolution_comparison} the resolution of the reconstructed top-quark spin correlation observable $c_{\text{hel}}$ for the different jet assignment methods is plotted. This variable is sensitive to both the jet selection and assignment, because the correct pairing of $b$-jets to leptons is crucial for accurately reconstructing the top-quark decay kinematics. The latter are used to boost the leptons into the top-quark restframe, which is required to compute $c_{\text{hel}}$ (See \Cref{sec:spin_sensitive_variables}). This makes $c_{\text{hel}}$ an interesting observable to study the impact of jet assignment performance.
In contrast to $m(t\bar{t})$, the transformer provides a more moderate improvement in resolution over the conventional methods for $c_{\text{hel}}$. Further, its resolution is noticeably worse than the ideal case of perfect jet assignment. This is expected, given that $c_{\text{hel}}$ is sensitive to both jet selection and assignment, and the transformer, while significantly better at assignment, still makes mistakes in both tasks.
Also, in the lowest bin, the $\chi^2$-Method seems to outperform the transformer. Since both methods achieved a similar assignment accuracy in this regime, this indicates that the $\chi^2$-Method makes its mistakes in a way that has a less detrimental impact on the $C_\text{han}$ resolution. This might be since the mistakes made by the $\chi^2$-Method more often involve selection a wrong jet, while the transformer might misassign the selected jets more frequently. Since $c_{\text{hel}}$ is sensitive to the correct pairing of jets and leptons, misassignments seem to have a larger negative impact on its resolution compared to incorrect selections.
The gap between the different assignment methods and the perfect assignment case widens significantly towards the lower $m(t\bar{t})$ values. This is consistent with the findings in \Cref{fig:accuracy_m_ttbar}, where all methods suffered a significant drop in assignment accuracy near the production threshold. This highlights the challenges posed by events close to the production threshold, where the kinematics are less distinct, making especially the jet assignment more difficult. It also underscores room for further improvements in jet assignment methods to improve the reconstruction of spin-sensitive observables in this challenging regime.
A similar trend can be observed for the resolution of the observable $C_{\text{han}}$, which is included in the Appendix in \Cref{fig:c_han_resolution_comparison}. Since $C_{\text{han}}$ also relies on the correct pairing of jets and leptons for its calculation, it exhibits similar sensitivities to jet assignment performance as $c_{\text{hel}}$. The transformer again provides a moderate improvement over the conventional methods, but still falls short of the ideal case of perfect jet assignment, especially at low $m(t\bar{t})$ values.

\section{Near-Threshold Optimized Model}
Given the challenges associated with jet assignment in events near the $t\bar{t}$ production threshold, a specialized transformer model is trained focusing exclusively on this regime. For this purpose, a dedicated dataset with events from the toponium-resonance ($m(t\bar{t}) < 390~\unit{\giga\electronvolt}$) is used\footnote{Note, that the use of a sample containing events from the toponium-resonance, might introduce additional biases from the diverging angular correlation in these events compared to the nominal sample. It was used, because it was the only Monte Carlo sample containing only low $m(t\bar{t})$ events available at the moment.}. One of the mayor advantages of machine learning-based methods is their flexibility to be adapted to specific event categories or kinematic regimes. To test this, the transformer architecture is retrained on specialized datasets, while keeping the hyperparameters fixed to those found during the optimization in \Cref{sec:hyperparameter-optimisation}. This Section explores the performance of three models:
\begin{itemize}
    \item \textbf{Nominal Trained Transformer}: The transformer model trained on the full dataset, as described in \Cref{chap:ml-jet-selection} and evaluated in the previous sections.
    \item \textbf{Toponium Trained Transformer}: A transformer model trained exclusively on events with $m(t\bar{t}) < 390~\unit{\giga\electronvolt}$.
    \item \textbf{Mixed Trained Transformer}: A transformer model trained on a combination of both the full dataset and the near-threshold dataset, which contains equal parts of events from both regimes.
\end{itemize}

\begin{table}[H]
    \centering
    \input{plots/compare_mixed_model/reconstruction_accuracies_table}
    \caption{Reconstruction accuracies for the different jet assignment methods on the nominal test dataset.}
    \label{tab:reconstruction_accuracies_near_threshold_model}
\end{table}

The performance of the three models is evaluated on the nominal test dataset, which contains events across the entire $m(t\bar{t})$ spectrum. \Cref{tab:reconstruction_accuracies_near_threshold_model} summarizes the selection and assignment accuracies achieved by the different models. The results show, that the \textbf{Toponium Trained Transformer} significantly underperforms compared to the other two models when evaluated on the full dataset. Given its still high selection accuracy of $85.9\%$, this indicates, the assignment accuracy of only $23.48\%$ is much lower, than the accuracy randomly assigning the correctly selected jets would yield. This suggests, that the model has picked up a special set of features or patterns specific to the near-threshold events, which do not generalize well to the broader event population. This highlights, the kinematic differences between near-threshold events and those at higher invariant masses. The \textbf{Mixed Trained Transformer} performs much better, achieving an assignment accuracy of $77.5\%$, which is closer to the nominal model's performance of $81.79\%$. Its selection accuracy is almost equal to that of the nominal model. 

\begin{figure}[H]
    \begin{subfigure}{0.49\textwidth}
        \includegraphics[width=1.0\textwidth]{plots/compare_mixed_model/binned_selection_accuracy_ttbar_mass.pdf}
        \caption{Selection Accuracy}
        \label{fig:selection_accuracy_near_threshold_model}
    \end{subfigure}
    \begin{subfigure}{0.49\textwidth}
        \includegraphics[width=1.0\textwidth]{plots/compare_mixed_model/binned_accuracy_ttbar_mass.pdf}
        \caption{Assignment Accuracy}
        \label{fig:assignment_accuracy_near_threshold_model}
    \end{subfigure}
    \caption{Accuracy metrics as a function of the reconstructed $t\bar{t}$ invariant mass for the differently trained models. The error bars represent the statistical uncertainty. The distribution of events across the bins is shown in the red distribution in the background. A dotted line, indicates the expected accuracy from random guessing based on the number of jet combinations in each bin.}
    \label{fig:accuracy_near_threshold_model}
\end{figure}

To investigate how the models behave across the $m(t\bar{t})$ spectrum, \Cref{fig:accuracy_near_threshold_model} shows the selection and assignment accuracies as a function of the true $t\bar{t}$ invariant mass for the different models. While the selection accuracy of the \textbf{Toponium Trained Transformer} slowly decreases for higher invariant masses, the two other models maintain a very stable selection performance across the entire spectrum. This indicates, that the features learned by the \textbf{Toponium Trained Transformer} for jet selection do not generalize well to higher mass events, while the other two models have learned more robust selection criteria.

For the assignment accuracy, the \textbf{Toponium Trained Transformer} declines steeply in performance as the invariant mass increases, further highlighting its lack of generalization. Its performance drops below that of random guessing for a large part of the spectrum. In contrast, the \textbf{Mixed Trained Transformer} closely follows the performance of the nominal model across the entire mass range, albeit with a slightly lower accuracy in the region above $400~\unit{\giga\electronvolt}$. In the lowest $m(t\bar{t})$, however, it performs best. This suggests, that while the model is able to pick up the specific features of both ends of the spectrum, it can only do so at the cost of a small decrease in performance in the intermediate mass region. This can be understood, as the model has difficulty reconciling the differing kinematic patterns present in the two regimes, leading to a compromise in performance. Especially in the intermediate region, where neither set of features is dominant, and the model struggles to tell from which regime the event originates.